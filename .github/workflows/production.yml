name: Build and Deploy to Production

on:
  push:
    branches:
      - production
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug SSH connection info
        run: |
          echo "Host length: ${#HOST}"
          echo "Username length: ${#USERNAME}"
          echo "Key length: ${#KEY}"
          echo "Host first 5 chars: ${HOST:0:5}"
        env:
          HOST: ${{ secrets.PRODUCTION_SSH_HOST }}
          USERNAME: ${{ secrets.PRODUCTION_SSH_USERNAME }}
          KEY: ${{ secrets.PRODUCTION_SSH_PRIVATE_KEY }}

      - name: Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_SSH_HOST }}
          username: ${{ secrets.PRODUCTION_SSH_USERNAME }}
          key: ${{ secrets.PRODUCTION_SSH_PRIVATE_KEY }}
          debug: true
          script: |
            echo "ðŸš€ Starting PRODUCTION deployment at $(date)"

            # Ensure we're in the user's home directory
            cd $HOME
            echo "ðŸ“ Current directory: $(pwd)"
            echo "ðŸ‘¤ Current user: $(whoami)"

            # Deploy path - explicitly in home directory
            DEPLOY_PATH="$HOME/fullstack_portal"
            echo "ðŸŽ¯ Deploy path: $DEPLOY_PATH"

            # Stop existing containers first (if they exist)
            if [ -d "$DEPLOY_PATH" ]; then
              echo "ðŸ›‘ Stopping existing containers..."
              cd $DEPLOY_PATH
              docker compose --env-file .env.production down || true
              docker compose down || true
            fi

            # Remove old deployment
            echo "ðŸ—‘ï¸ Removing old deployment..."
            cd $HOME
            sudo rm -rf $DEPLOY_PATH

            # Verify removal
            if [ -d "$DEPLOY_PATH" ]; then
              echo "âŒ Failed to remove $DEPLOY_PATH"
              ls -la $DEPLOY_PATH
              exit 1
            fi

            # Clone fresh
            echo "ðŸ“¥ Cloning fresh code..."
            mkdir -p $DEPLOY_PATH
            cd $DEPLOY_PATH
            git clone https://github.com/${{ vars.REPO_OWNER }}/${{ vars.REPO_NAME }}.git .

            # Checkout production branch
            git checkout production

            echo "ðŸ“‹ Creating environment file..."
            # Create .env.production file
            cat > .env.production << 'EOF'
            # Environment
            NODE_ENV=production
            VITE_ENV=production

            # Domain Configuration
            VITE_DOMAIN_NAME=${{ secrets.VITE_DOMAIN_NAME }}
            FRONTEND_URL=${{ secrets.FRONTEND_URL }}
            VITE_DEV_API_URL=${{ secrets.VITE_DEV_API_URL }}
            VITE_DOCKER_API_URL=${{ secrets.VITE_DOCKER_API_URL }}
            VITE_API_URL=${{ secrets.VITE_API_URL }}

            # JWT Secrets
            ACCESS_TOKEN_SECRET=${{ secrets.ACCESS_TOKEN_SECRET }}
            REFRESH_TOKEN_SECRET=${{ secrets.REFRESH_TOKEN_SECRET }}

            # MongoDB Database
            DATABASE_URI=${{ secrets.DATABASE_URI }}

            # GitHub Integration
            FULLSTACK_PORTAL_ISSUES_TOKEN=${{ secrets.FULLSTACK_PORTAL_ISSUES_TOKEN }}
            REPO_OWNER=${{ vars.REPO_OWNER }}
            REPO_NAME=${{ vars.REPO_NAME }}

            # Email Configuration
            SMTP_HOST=${{ secrets.SMTP_HOST }}
            SMTP_PORT=${{ secrets.SMTP_PORT }}
            SMTP_USER=${{ secrets.SMTP_USER }}
            SMTP_PASS=${{ secrets.SMTP_PASS }}
            FROM_NAME=${{ vars.FROM_NAME }}
            FROM_EMAIL=${{ vars.FROM_EMAIL }}

            # Promark Database
            PROMARK_DB_USER=${{ secrets.PROMARK_DB_USER }}
            PROMARK_DB_PASSWORD=${{ secrets.PROMARK_DB_PASSWORD }}
            PROMARK_DB_SERVER=${{ secrets.PROMARK_DB_SERVER }}
            PROMARK_DB_NAME=${{ secrets.PROMARK_DB_NAME }}

            # Voxco Database
            VOXCO_DB_USER=${{ secrets.VOXCO_DB_USER }}
            VOXCO_DB_PASSWORD=${{ secrets.VOXCO_DB_PASSWORD }}
            VOXCO_DB_SERVER=${{ secrets.VOXCO_DB_SERVER }}
            VOXCO_DB_NAME=${{ secrets.VOXCO_DB_NAME }}

            # Voxco API
            VOXCO_API_USERNAME=${{ secrets.VOXCO_API_USERNAME }}
            VOXCO_API_PASSWORD=${{ secrets.VOXCO_API_PASSWORD }}
            VOXCO_API_CONTEXT=${{ secrets.VOXCO_API_CONTEXT }}
            VOXCO_WEB_API_ACCESS_KEY=${{ secrets.VOXCO_WEB_API_ACCESS_KEY }}

            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}

            # Docker Registry
            DOCKER_REGISTRY=${{ secrets.DOCKER_REGISTRY }}
            IMAGE_TAG=${{ vars.IMAGE_TAG }}

            EOF

            # Strip leading whitespace from env file
            sed -i 's/^[[:space:]]*//' .env.production

            # Debug: Show first few lines of env file (without secrets)
            echo "ðŸ“‹ Env file structure (first 5 lines):"
            head -5 .env.production

            # Verify we're in the right directory
            echo "ðŸ“‚ Files in deploy directory:"
            ls -la

            # Build and start with the default docker-compose file
            echo "ðŸ”¨ Building and starting containers..."
            docker compose --env-file .env.production up -d --build

            # Wait for services
            echo "â³ Waiting for services to start..."
            sleep 30

            # Check status
            echo "ðŸ“Š Container status:"
            docker compose --env-file .env.production ps

            # Show container logs for debugging
            echo "ðŸ“œ Container logs:"
            docker compose --env-file .env.production logs --tail=10

            # Test endpoints
            echo "ðŸ§ª Testing API..."
            curl -f "https://${{ secrets.VITE_DOMAIN_NAME }}/api/health" || echo "API not ready"

            echo "ðŸ§ª Testing Frontend..."
            curl -f "https://${{ secrets.VITE_DOMAIN_NAME }}" || echo "Frontend not ready"

            echo "âœ… PRODUCTION Deployment completed at $(date)"
            echo "ðŸŒ Site available at: https://${{ secrets.VITE_DOMAIN_NAME }}"
