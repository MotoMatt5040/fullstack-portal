name: Simple Deploy Test

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allows manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Portal Development Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.TESTING_SSH_HOST }}
          username: ${{ secrets.TESTING_SSH_USERNAME }}
          key: ${{ secrets.TESTING_SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸš€ Starting deployment at $(date)"
            echo "ğŸ“ Current user: $(whoami)"
            echo "ğŸ“ Current directory: $(pwd)"
            
            # Navigate to deployment directory
            DEPLOY_PATH="/opt/fullstack-portal"
            echo "ğŸ“ Deploy path: $DEPLOY_PATH"
            
            # Create directory if it doesn't exist
            sudo mkdir -p $DEPLOY_PATH
            sudo chown $(whoami):$(whoami) $DEPLOY_PATH
            cd $DEPLOY_PATH
            
            # Clone or pull latest code
            if [ -d ".git" ]; then
              echo "ğŸ“¦ Updating existing repository..."
              git fetch origin
              git reset --hard origin/main
            else
              echo "ğŸ“¦ Cloning repository..."
              git clone https://github.com/${{ github.repository }}.git .
            fi
            
            echo "ğŸ”§ Current directory: $(pwd)"
            echo "ğŸ“‹ Files in directory:"
            ls -la
            
            # Check if Docker is available
            if command -v docker >/dev/null 2>&1; then
              echo "ğŸ³ Docker is available"
              docker --version
              
              # Check if docker-compose is available
              if command -v docker-compose >/dev/null 2>&1; then
                echo "ğŸ³ Docker Compose is available"
                docker-compose --version
              elif docker compose version >/dev/null 2>&1; then
                echo "ğŸ³ Docker Compose (plugin) is available"
                docker compose version
              else
                echo "âŒ Docker Compose not found"
              fi
            else
              echo "âŒ Docker not found"
            fi
            
            echo "âœ… Basic deployment test completed at $(date)"