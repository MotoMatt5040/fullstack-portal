name: SSH Debug Test

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allows manual triggering

jobs:
  debug-ssh:
    runs-on: ubuntu-latest
    
    steps:
      - name: Debug SSH Connection
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.TESTING_SSH_HOST }}
          username: ${{ secrets.TESTING_SSH_USERNAME }}
          key: ${{ secrets.TESTING_SSH_PRIVATE_KEY }}
          debug: true
          script: |
            echo "ğŸ‰ SSH connection successful!"
            echo "ğŸ“… Current time: $(date)"
            echo "ğŸ‘¤ Current user: $(whoami)"
            echo "ğŸ“ Current directory: $(pwd)"
            echo "ğŸ  Home directory: $HOME"
            echo "ğŸ”‘ SSH agent info:"
            ssh-add -l 2>/dev/null || echo "No SSH agent or keys loaded"
            echo "ğŸŒ Network info:"
            hostname -I
            echo "âœ… Basic connection test complete"

  manual-ssh-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Manual SSH Test with Verbose Output
        run: |
          echo "ğŸ” Testing SSH connection manually with verbose output..."
          
          # Create temporary key file
          echo "${{ secrets.TESTING_SSH_PRIVATE_KEY }}" > /tmp/ssh_key
          chmod 600 /tmp/ssh_key
          
          echo "ğŸ”‘ Key file created, testing connection..."
          echo "ğŸ“‹ Key file info:"
          ls -la /tmp/ssh_key
          
          echo "ğŸ” Key file first/last lines:"
          head -1 /tmp/ssh_key
          tail -1 /tmp/ssh_key
          
          echo "ğŸŒ Testing SSH connection with maximum verbosity..."
          ssh -vvv -i /tmp/ssh_key \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              -o BatchMode=yes \
              ${{ secrets.TESTING_SSH_USERNAME }}@${{ secrets.TESTING_SSH_HOST }} \
              "echo 'Connection successful'" || echo "SSH connection failed"
          
          # Clean up
          rm /tmp/ssh_key