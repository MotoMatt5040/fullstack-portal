name: Build and Deploy to Testing

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: testing
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Testing Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.TESTING_SSH_HOST }}
          username: ${{ secrets.TESTING_SSH_USERNAME }}
          key: ${{ secrets.TESTING_SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸš€ Starting deployment at $(date)"
            
            # Ensure we're in the user's home directory
            cd $HOME
            echo "ğŸ“ Current directory: $(pwd)"
            echo "ğŸ‘¤ Current user: $(whoami)"
            
            # Deploy path - explicitly in home directory
            DEPLOY_PATH="$HOME/fullstack_portal"
            echo "ğŸ¯ Deploy path: $DEPLOY_PATH"
            
            # Stop existing containers first (if they exist)
            if [ -d "$DEPLOY_PATH" ]; then
              echo "ğŸ›‘ Stopping existing containers..."
              cd $DEPLOY_PATH
              docker compose --env-file .env.testing -f docker-compose.testing.yml down || true
              docker compose down || true
            fi
            
            # Remove old deployment
            echo "ğŸ—‘ï¸ Removing old deployment..."
            rm -rf $DEPLOY_PATH
            
            # Clone fresh
            echo "ğŸ“¥ Cloning fresh code..."
            mkdir -p $DEPLOY_PATH
            cd $DEPLOY_PATH
            git clone https://github.com/${{ vars.REPO_OWNER }}/${{ vars.REPO_NAME }}.git .
            
            echo "ğŸ“‹ Creating environment file..."
            # Create .env.testing file (not .env)
            cat > .env.testing << 'EOF'
            # Environment
            NODE_ENV=testing
            VITE_ENV=testing
            COMPOSE_ENV=testing
            
            # Domain Configuration (TESTING URL)
            VITE_DOMAIN_NAME=${{ secrets.VITE_DOMAIN_NAME }}
            FRONTEND_URL=${{ secrets.FRONTEND_URL }}
            VITE_DEV_API_URL=${{ secrets.VITE_DEV_API_URL }}
            VITE_DOCKER_API_URL=${{ secrets.VITE_DOCKER_API_URL }}
            
            # All your other secrets
            ACCESS_TOKEN_SECRET=${{ secrets.ACCESS_TOKEN_SECRET }}
            REFRESH_TOKEN_SECRET=${{ secrets.REFRESH_TOKEN_SECRET }}
            DATABASE_URI=${{ secrets.DATABASE_URI }}
            
            # Email
            SMTP_HOST=${{ secrets.SMTP_HOST }}
            SMTP_PORT=${{ secrets.SMTP_PORT }}
            SMTP_USER=${{ secrets.SMTP_USER }}
            SMTP_PASS=${{ secrets.SMTP_PASS }}
            FROM_NAME=${{ vars.FROM_NAME }}
            FROM_EMAIL=${{ vars.FROM_EMAIL }}
            
            EOF
            
            # Verify we're in the right directory
            echo "ğŸ“‚ Files in deploy directory:"
            ls -la
            
            # Build and start with the testing docker-compose file
            echo "ğŸ”¨ Building and starting containers..."
            docker compose --env-file .env.testing -f docker-compose.testing.yml up -d --build
            
            # Wait for services
            echo "â³ Waiting for services to start..."
            sleep 30
            
            # Check status
            echo "ğŸ“Š Container status:"
            docker compose --env-file .env.testing -f docker-compose.testing.yml ps
            
            # Show container logs for debugging
            echo "ğŸ“œ Container logs:"
            docker compose --env-file .env.testing -f docker-compose.testing.yml logs --tail=10
            
            # Test endpoints
            echo "ğŸ§ª Testing API..."
            curl -f "https://${{ secrets.VITE_DOMAIN_NAME }}/api/health" || echo "API not ready"
            
            echo "ğŸ§ª Testing Frontend..."
            curl -f "https://${{ secrets.VITE_DOMAIN_NAME }}" || echo "Frontend not ready"
            
            echo "âœ… Deployment completed at $(date)"
            echo "ğŸŒ Site available at: https://${{ secrets.VITE_DOMAIN_NAME }}"